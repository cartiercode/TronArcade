<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Space Invaders</title>
    <script src="https://cdn.jsdelivr.net/npm/tronweb/dist/TronWeb.js"></script>
    <style>
        body { margin: 0; background: #000; display: flex; justify-content: center; align-items: center; height: 100vh; }
        #game-container { position: relative; transform: rotate(90deg); transform-origin: center; }
        canvas { background: #000; width: 256px; height: 224px; image-rendering: pixelated; }
        #ui { position: absolute; color: #fff; font-family: Arial; font-size: 16px; }
        #score { top: -20px; left: 10px; }
        #lives { top: -20px; right: 10px; }
        #submitScore { bottom: -40px; left: 50%; transform: translateX(-50%); }
    </style>
</head>
<body>
    <div id="game-container">
        <canvas id="gameCanvas" width="256" height="224"></canvas>
        <div id="ui">
            <div id="score">SCORE: 0</div>
            <div id="lives">LIVES: 3</div>
            <button id="submitScore" disabled>Submit to Tron</button>
        </div>
    </div>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const submitButton = document.getElementById('submitScore');
        ctx.imageSmoothingEnabled = false;

        // TronWeb stub (replace address after deployment)
        let tronWeb, contract;
        const contractAddress = "YOUR_CONTRACT_ADDRESS_HERE";
        const contractABI = [/* Paste ABI from previous message */];
        async function initTronWeb() {
            if (window.tronWeb && window.tronWeb.defaultAddress) {
                tronWeb = window.tronWeb;
                contract = await tronWeb.contract(contractABI, contractAddress);
                document.getElementById('payBtn')?.addEventListener('click', async () => {
                    await contract.payToPlay().send({ callValue: tronWeb.toSun(1) });
                    alert("Paid 1 TRX! Play now.");
                });
                submitButton.onclick = async () => {
                    await contract.submitScore(score, tronWeb.sha3("gameState")).send();
                    alert("Score submitted: " + score);
                };
            }
        }
        setTimeout(initTronWeb, 1000);

        // Game state
        const player = { x: 112, y: 200, width: 16, height: 8, speed: 2, lives: 3 };
        const bullets = [];
        const aliens = [];
        const bunkers = [];
        let score = 0, gameOver = false, alienSpeed = 1, alienStep = 0, alienDir = 1;

        // Aliens (5x11 grid)
        for (let row = 0; row < 5; row++) {
            for (let col = 0; col < 11; col++) {
                aliens.push({ x: 16 + col * 16, y: 32 + row * 16, width: 12, height: 8, alive: true, row });
            }
        }

        // Bunkers (4 blocks)
        for (let i = 0; i < 4; i++) {
            bunkers.push({ x: 40 + i * 56, y: 168, width: 24, height: 16, health: 4 });
        }

        // Inputs
        let keys = {};
        document.addEventListener('keydown', e => { keys[e.key] = true; if (e.key === ' ' && !gameOver) shoot(); });
        document.addEventListener('keyup', e => delete keys[e.key]);

        function shoot() {
            bullets.push({ x: player.x + player.width / 2, y: player.y, width: 2, height: 6, speed: -4, player: true });
        }

        function update() {
            if (gameOver) return;

            // Player movement
            if (keys['ArrowLeft'] && player.x > 0) player.x -= player.speed;
            if (keys['ArrowRight'] && player.x + player.width < 256) player.x += player.speed;

            // Bullets
            bullets.forEach((b, i) => {
                b.y += b.speed;
                if (b.y < 0 || b.y > 224) bullets.splice(i, 1);
            });

            // Aliens
            alienStep++;
            if (alienStep % 30 === 0) { // Move every 30 frames (~0.5s at 60fps)
                let edgeHit = aliens.some(a => a.alive && (a.x + alienDir * alienSpeed < 0 || a.x + alienDir * alienSpeed + a.width > 256));
                if (edgeHit) {
                    alienDir *= -1;
                    aliens.forEach(a => { if (a.alive) a.y += 8; });
                } else {
                    aliens.forEach(a => { if (a.alive) a.x += alienDir * alienSpeed; });
                }
                alienSpeed = 1 + (55 - aliens.filter(a => a.alive).length) / 20; // Speed up as aliens die
                if (Math.random() < 0.02) alienShoot();
            }

            // Collisions
            bullets.forEach((b, bi) => {
                aliens.forEach((a, ai) => {
                    if (a.alive && b.player && b.x < a.x + a.width && b.x + b.width > a.x && b.y < a.y + a.height && b.y + b.height > a.y) {
                        a.alive = false;
                        bullets.splice(bi, 1);
                        score += [30, 20, 20, 10, 10][a.row];
                    }
                });
                bunkers.forEach(bu => {
                    if (b.x < bu.x + bu.width && b.x + b.width > bu.x && b.y < bu.y + bu.height && b.y + b.height > bu.y) {
                        bullets.splice(bi, 1);
                        bu.health--;
                    }
                });
                if (!b.player && b.x < player.x + player.width && b.x + b.width > player.x && b.y < player.y + player.height && b.y + b.height > player.y) {
                    bullets.splice(bi, 1);
                    player.lives--;
                    if (player.lives <= 0) gameOver = true;
                }
            });

            if (aliens.every(a => !a.alive) || aliens.some(a => a.alive && a.y + a.height > player.y)) {
                gameOver = true;
                submitButton.disabled = false;
            }
        }

        function alienShoot() {
            let shooters = [];
            for (let col = 0; col < 11; col++) {
                let colAliens = aliens.filter(a => a.alive && Math.floor((a.x - 16) / 16) === col);
                if (colAliens.length) shooters.push(colAliens[colAliens.length - 1]); // Bottom-most alien
            }
            if (shooters.length) {
                let s = shooters[Math.floor(Math.random() * shooters.length)];
                bullets.push({ x: s.x + s.width / 2, y: s.y + s.height, width: 2, height: 6, speed: 4, player: false });
            }
        }

        function draw() {
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, 256, 224);

            // Player
            ctx.fillStyle = '#fff';
            ctx.fillRect(player.x, player.y, player.width, player.height);

            // Bullets
            bullets.forEach(b => ctx.fillRect(b.x, b.y, b.width, b.height));

            // Aliens
            aliens.forEach(a => {
                if (a.alive) ctx.fillRect(a.x, a.y, a.width, a.height);
            });

            // Bunkers
            bunkers.forEach(b => {
                if (b.health > 0) ctx.fillRect(b.x, b.y, b.width, b.height * b.health / 4);
            });

            // UI
            document.getElementById('score').textContent = `SCORE: ${score}`;
            document.getElementById('lives').textContent = `LIVES: ${player.lives}`;
            if (gameOver) ctx.fillText('GAME OVER', 80, 112);
        }

        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }
        gameLoop();
    </script>
</body>
</html>
